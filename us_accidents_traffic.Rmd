---
authors: 
title: "us_accidents_traffic"
output: html_document
date: "2022-10-22"
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

```{r Libraries Used}
library(tidyverse)
library(dplyr)
library(corrplot)
library(mapview)
library(tigris)
library(sf)
library(ggplot2)
library(lubridate)
library(ezids)
```

```{r intro}
df_us_acc <- data.frame(read.csv('../us_accidents_dataset/US_Accidents_Dec21_updated.csv'))
str(df_us_acc)
```

```{r}
(colMeans(is.na(df_us_acc)))*100
```


```{r}
df_us_acc$year<-format(as.Date(df_us_acc$Start_Time, format="%Y-%m-%d"),"%Y")
head(df_us_acc)
```

```{r}
ggplot(df_us_acc, aes(x = year, fill=year)) +
    geom_bar()
```


```{r}
accidents_2021 <- subset(df_us_acc, year==2021)
head(accidents_2021)
```

```{r}
accidents_2021$month<-format(as.Date(accidents_2021$Start_Time, format="%Y-%m-%d"),"%m")
head(accidents_2021)
```

```{r}
accidents_2021<-subset(accidents_2021, select = -c(Number, ID, Description))
```

```{r}
(colMeans(is.na(accidents_2021)))*100
```

```{r}
accidents_2021 <- accidents_2021 %>% 
  mutate(Is_severe = if_else(Severity == 1 | Severity ==2 , "Not Severe", "Severe"))
```

```{r}
accidents_2021  %>%
  summarise_all(list(~is.na(.)))%>%
  pivot_longer(everything(),
               names_to = "variables", values_to="missing") %>%
  count(variables, missing) %>%
  ggplot(aes(y=variables,x=n,fill=missing))+
  geom_col()
```



```{r Drop NA, Factorize severity}
clean_acc21 <- drop_na(accidents_2021)

```

```{r}
clean_acc21$Is_severe <- as.factor(clean_acc21$Is_severe) # make Is_severe as factor
str(clean_acc21)
```

```{r}
clean_acc21  %>%
  summarise_all(list(~is.na(.)))%>%
  pivot_longer(everything(),
               names_to = "variables", values_to="missing") %>%
  count(variables, missing) %>%
  ggplot(aes(y=variables,x=n,fill=missing))+
  geom_col()
```

```{r}
us_date<-clean_acc21$Start_Time 
us_date_formatted<- as.Date(us_date,format="%Y-%m-%d")
clean_acc21$Month<-as.numeric(format(us_date_formatted, "%m"))
```

```{r}
us_time<- clean_acc21$Start_Time
clean_acc21$Hour<-hour(us_time)
```

```{r}

ggplot(clean_acc21, aes(x = month, fill=month,)) +geom_bar()+labs(title="Accident Distribution over the Months in 2021", x="Months", y = "count")+
  theme(plot.title = element_text(hjust = 0.5))
```
The Graph above shows frequency of Accidents in 2021 during different Months.
```{r}
ggplot(clean_acc21, aes(x = Hour, fill=as.factor(Hour))) + geom_bar()+
  labs(title="Accident Distribution in Hours ", x="Hours", y = "count")+
  theme(plot.title = element_text(hjust = 0.5))
```
The graph above shows the frequency of accidents in 2021 during different hours of the day.
```{r}
us_time<- accidents_2021$Start_Time
us_time_formatted<-hour(us_time)
hist(us_time_formatted)
```

```{r}
df_map<-dplyr::select(clean_acc21, State, Start_Lat, Start_Lng)
head(df_map)
```

```{r}
df_map_DC <- df_map %>% filter(State == "DC")

df_map_DC %>% glimpse()
```

```{r}
df_map_DC_sf <- st_as_sf(df_map_DC, coords = c("Start_Lng", "Start_Lat"), crs = 4326)
```

```{r}
mapview(df_map_DC_sf, xcol = "Start_Lng", ycol = "Start_Lat", grid = FALSE,col.regions=("red"))
```
The map above shows the accidents that took place in 2021 in the DC area.

```{r}
mapview(df_map_DC_sf, map.types = "Stamen.Toner",col.regions=("red"))
```
The map above shows the accidents that took place in 2021 in the DC area.

```{r Correlations for numerical values}
# sub-setting numerical columns only to check the corelation between numerical variables
loadPkg("corrplot")
num_clean_acc21 <- select_if(clean_acc21, is.numeric)
str(num_clean_acc21)
cor_num_clean_acc21 <- cor(num_clean_acc21)
cor_num_clean_acc21
corrplot(cor_num_clean_acc21, method = "number")
```

```{r Histograms for Weather Conditions}

tempHist <- ggplot(clean_acc21, aes(x=Temperature.F.)) + geom_histogram(color="black", fill = "red")+
  ggtitle("Histogram of Temperature(F) for accidents")
tempHist

windcHist <- ggplot(clean_acc21, aes(x=Wind_Chill.F.)) + geom_histogram(color="black", fill = "orange")+
  ggtitle("Histogram of Wind chill for accidents")
windcHist

humidHist <- ggplot(clean_acc21, aes(x=Humidity...)) + geom_histogram(color="black", fill = "yellow")+
  ggtitle("Histogram of Humidity for accidents")
humidHist

windsHist <- ggplot(clean_acc21, aes(x=Wind_Speed.mph.)) + geom_histogram(color="black", fill = "navy")+
  ggtitle("Histogram of Wind Speed for accidents")
windsHist

pressHist <- ggplot(clean_acc21, aes(x=Pressure.in.)) + geom_histogram(color="black", fill = "green")+
  ggtitle("Histogram of Pressure for accidents")
pressHist

visibHist <- ggplot(clean_acc21, aes(x=Visibility.mi.)) + geom_histogram(color="black", fill = "blue")+
  ggtitle("Histogram of Visibility for accidents")
visibHist

precipHist <- ggplot(clean_acc21, aes(x=Precipitation.in.)) + geom_histogram(color="black", fill = "purple")+
  ggtitle("Histogram of Precipitation for accidents")
precipHist

```

First, we looked at the histogram between numbers of accidents and weather condition elements to check distribution of data.
For Temperature, Wind chill, and Humanity, each of distributions is left-skewed. 
For the rest of element, they have quite close mean and median and a few outliers. But we decided to keep the outliers because it is natural to have outliers in the weather condition elements as it covers a whole year. Also the outliers does not affect the result of T-test. 

```{r boxplots between Severity and wind conditions elements }

ggplot(clean_acc21, aes(x = Is_severe, y=Temperature.F.)) + 
  geom_boxplot() +
  labs(title="Temperature by Severity", x="Severity", y = "Temperature(F)")

ggplot(clean_acc21, aes(x = Is_severe, y=Wind_Chill.F.)) + 
  geom_boxplot() +
  labs(title="Wind Chill by Severity", x="Severity", y = "Wind Chill")

ggplot(clean_acc21, aes(x = Is_severe, y=Wind_Speed.mph.)) + 
  geom_boxplot() +
  labs(title="Wind Speed by Severity", x="Severity", y = "Wind Speed")

ggplot(clean_acc21, aes(x = Is_severe, y=Humidity...)) + 
  geom_boxplot() +
  labs(title="Humidity by Severity", x="Severity", y = "Humidity")

ggplot(clean_acc21, aes(x = Is_severe, y=Pressure.in.)) + 
  geom_boxplot() +
  labs(title="Pressure by Severity", x="Severity", y = "Pressure")

ggplot(clean_acc21, aes(x = Is_severe, y=Visibility.mi.)) + 
  geom_boxplot() +
  labs(title="Visibility by Severity", x="Severity", y = "Visibility")

ggplot(clean_acc21, aes(x = Is_severe, y=Precipitation.in.)) + 
  geom_boxplot() +
  labs(title="Precipitation by Severity", x="Severity", y = "Precipitation")

## The same variables(Temp, wind chill, humidity) have pretty plots

```

```{r T-test on Severity and weather condition elements}
box_clean2_severe = subset(clean_acc21, Is_severe == 'Severe')
box_clean2_notsevere = subset(clean_acc21, Is_severe == 'Not Severe')
print("Temperature.F")
t.test(box_clean2_severe$Temperature.F., box_clean2_notsevere$Temperature.F.)
print("Wind_Chill.F.")
t.test(box_clean2_severe$Wind_Chill.F., box_clean2_notsevere$Wind_Chill.F.)
print("Humidity...")
t.test(box_clean2_severe$Humidity..., box_clean2_notsevere$Humidity...)
print("Wind_Speed.mph.")
t.test(box_clean2_severe$Wind_Speed.mph., box_clean2_notsevere$Wind_Speed.mph.)
print("Visibility.mi.")
t.test(box_clean2_severe$Visibility.mi., box_clean2_notsevere$Visibility.mi.)
print("Pressure.in.")
t.test(box_clean2_severe$Pressure.in., box_clean2_notsevere$Pressure.in.)
print("Precipitation.in.")
t.test(box_clean2_severe$Precipitation.in., box_clean2_notsevere$Precipitation.in.)
```
H0: The means of Temperature/WindChill/Humidity/Wind Speed/Pressure/Visibility/Precipitation will be same between different Severity levels.
H1: The means of Temperature/WindChill/Humidity/Wind Speed/Pressure/Visibility/Precipitation will NOT be same between different Severity levels.
The P-value for the all are lower than 0.05 for those all so we can reject the H0 except for Precipitation.
```{r Wind_Direction}
# wind direction with severity
ggplot(clean_acc21, aes(Wind_Direction, ..prop.., group = Is_severe)) +
  geom_bar(aes(fill = Is_severe)) +
  #scale_y_continuous(labels = percent) +
  labs(x = "Wind Direction",
       y = "Proportion",
       title = "Wind direction by Severity") +
  theme(text = element_text(size=8)) 
```
As the bar plot between Severity and Wind direction here shows the similar distribution for each severity levels on most of wind direction, we can conclude that wind direction does not affect much on the severity of traffic.
```{r Weather_Condition variables}
# Weather Condition percentage
unique(clean_acc21$Weather_Condition)
WC <- clean_acc21 %>%
  group_by(Weather_Condition) %>%
  summarise(cnt = n()) %>%
  mutate(freq = (round(cnt/sum(cnt), 3))*100 )%>%
  arrange(desc(freq)) %>%
  filter(freq > 1)
WC
WC %>%
    ggplot() +
    geom_col(mapping = aes(x=reorder(Weather_Condition, -freq), y=freq, fill = Weather_Condition)) +
    labs(x = "Weather Condition", y="%", title ="Top 8 Weather Conditions with accidents") +
    theme(text = element_text(size=7))
```

```{r}
# Try the Chi-Squared Test on all Weather_Conditions and Severity
WCtable <- table(clean_acc21$Weather_Condition , clean_acc21$Severity)
xkabledply(WCtable, title = "Severity by Weather Conditions")
chitest = chisq.test(WCtable)
chitest
```
Took a Chi-Squared test to see the severity and weather conditions are independent.
H0 : Severity and weather conditions are independent
H1 : Severity and weather conditions are NOT independent
We can reject the H0. 


```{r}
clean_acc21 %>% 
      group_by(Amenity, Bump, Crossing, Give_Way, Junction, No_Exit, Railway, Roundabout, Station, Stop, Traffic_Calming, Traffic_Signal, Turning_Loop)%>%
    summarise(percentage = n()/nrow(clean_acc21) *100 )%>%
    arrange(-percentage) %>%
    filter(percentage > 1) -> accidents_per_roadelement

head(accidents_per_roadelement)
```



```{r}


acc_road_element_per <- tibble(c("None", "Junction","Crossing", "Traffic signal", "Crossing and traffic signal", "Station", "Stop" ), pull(accidents_per_roadelement, percentage), .name_repair = ~ c("road_elements", "percentage"))
acc_road_element_per
       
```


```{r}
options(repr.plot.width = 20, repr.plot.height = 8)
acc_road_element_per %>%
    ggplot() +
    geom_col(mapping = aes(x=reorder(road_elements, -percentage), y=percentage, fill = road_elements)) +
    labs(x = "Road element", y="%", title ="Accidents by nearby road element") +
    theme(text = element_text(size=8))
```

```{r}


accidents_per_roadelement<-clean_acc21 %>% 
      select(Is_severe,Crossing,Stop,Station,Traffic_Signal)


head(accidents_per_roadelement)

```






```{r}
Crossing_data<- subset(accidents_per_roadelement, Crossing=="True",
select=c(Is_severe,Crossing))
head(Crossing_data)
```
```{r}
ggplot(data=Crossing_data, aes(x=Is_severe, y=Crossing, fill=Is_severe)) +
  geom_bar(stat="identity")
```


```{r}
Stop_data<- subset(accidents_per_roadelement, Stop=="True",
select=c(Is_severe,Stop))
head(Stop_data)
```
```{r}
ggplot(data=Stop_data, aes(x=Is_severe, y=Stop, fill=Is_severe)) +
  geom_bar(stat="identity")
```

```{r}
Station_data<- subset(accidents_per_roadelement, Station=="True",
select=c(Is_severe,Station))
head(Station_data)
```
```{r}
ggplot(data=Station_data, aes(x=Is_severe, y=Station, fill=Is_severe)) +
  geom_bar(stat="identity")
```

```{r}
Traffic_Signal_data<- subset(accidents_per_roadelement, Traffic_Signal=="True",
select=c(Is_severe,Traffic_Signal))
head(Traffic_Signal_data)
```
```{r}
ggplot(data=Traffic_Signal_data, aes(x=Is_severe, y=Traffic_Signal, fill=Is_severe)) +
  geom_bar(stat="identity")
```



```{r}

accidents_per_roadelement <- accidents_per_roadelement %>% 
  mutate(severe_num = if_else(Is_severe== "Severe", 1, 0))
accidents_per_roadelement <- accidents_per_roadelement %>% 
  mutate(Crossing_num = if_else(Crossing== "True", 1, 0))
accidents_per_roadelement <- accidents_per_roadelement %>% 
  mutate(Stop_num = if_else(Stop== "True", 1, 0))
accidents_per_roadelement <- accidents_per_roadelement %>% 
  mutate(Station_num = if_else(Station== "True", 1, 0))
accidents_per_roadelement <- accidents_per_roadelement %>% 
  mutate(Traffic_Signal_num = if_else(Traffic_Signal== "True", 1, 0))
```



```{r}
Crossing_anova = aov(Crossing_num~severe_num, data=accidents_per_roadelement)
summary(Crossing_anova)
```


```{r}
Stop_anova = aov(Stop_num~severe_num, data=accidents_per_roadelement)
summary(Stop_anova)
```
```{r}
Station_anova = aov(Station_num~severe_num, data=accidents_per_roadelement)
summary(Station_anova)
```
```{r}
Traffic_signal_anova = aov(Traffic_Signal_num~severe_num, data=accidents_per_roadelement)
summary(Traffic_signal_anova)
```

```{r}
test_Hour <- chisq.test(table(clean_acc21$Severity, clean_acc21$Hour))
test_Hour
```
Took a Chi-Squared test to see if the severity and Hour of day are independent.
We have performed Chi-Squared test because both variables are categorical.
H0 : Severity and Hour are independent
H1 : Severity and Hour are NOT independent
We can reject the H0. 


```{r}
test_Month <- chisq.test(table(clean_acc21$Severity, clean_acc21$Month))
test_Month
```
Took a Chi-Squared test to see the severity and weather Months are independent.
We have performed Chi-Squared test because both variables are categorical.
H0 : Severity and Month are independent
H1 : Severity and Month are NOT independent
We can reject the H0. 


```{r}
cor(clean_acc21$Severity, clean_acc21$Month)
```
Correlation test is performed to check the strength of relationship between severity and months.

```{r}
cor(clean_acc21$Severity, clean_acc21$Hour)
```
Correlation test is performed to check the strength of relationship between severity and hours.
